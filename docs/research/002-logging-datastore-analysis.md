## 📝 리서치 #002: 로깅 및 데이터스토어 아키텍처 분석

**날짜**: 2025-11-19
**작성자**: Gemini AI
**상태**: ✅ 완료

### 1. 개요

본 문서는 MXRC 프로젝트의 핵심 모듈인 로깅 시스템과 DataStore의 현재 아키텍처를 분석하고, 성능 및 구조적 개선 기회를 식별하는 것을 목표로 합니다. 코드베이스 분석 도구를 통해 각 모듈의 구현 상태를 심층적으로 검토했습니다.

---

### 2. 로깅 시스템 (Logging System)

#### 2.1. 현황 분석

현재 프로젝트는 목적에 따라 두 가지 로깅 전략을 병행하고 있습니다.

1.  **커스텀 'Bag' 로거**: `src/core/logging`에 구현된 고성능 비동기 로거입니다. 구조화된 데이터(`BagMessage`)를 바이너리 파일에 효율적으로 기록하기 위해 설계되었으며, 논블로킹 큐(`AsyncWriter`)를 사용하여 애플리케이션 성능에 미치는 영향을 최소화합니다. 이 시스템은 목적에 맞게 잘 설계되었습니다.

2.  **`spdlog` 진단 로거**: 정보, 경고, 오류 등 일반적인 진단 메시지를 기록하기 위해 `spdlog` 라이브러리를 사용합니다. 분석 결과, 이 로거는 현재 **동기(Synchronous) 방식**으로 설정되어 있습니다. 이는 파일 I/O가 발생할 때마다 로깅을 호출한 스레드가 블로킹될 수 있음을 의미합니다.

#### 2.2. 문제점

- **성능 병목 위험**: `spdlog`의 동기식 사용은 성능에 민감한 제어 루프나 데이터 처리 경로에서 예기치 않은 지연(Latency)을 유발할 수 있습니다. 예를 들어, 파일 시스템 부하가 높을 때 로그를 기록하는 작업이 수십 밀리초 이상 소요될 수 있으며, 이는 전체 시스템의 반응성을 저해하는 원인이 됩니다.
- **설정의 분산**: 중앙화된 로거 설정이 없어, 코드베이스 여러 곳(특히 테스트 파일)에서 개별적으로 로거를 생성하고 있습니다. 이는 로깅 정책의 일관성을 해치고 유지보수를 어렵게 만듭니다.

#### 2.3. 권장 사항

1.  **`spdlog` 비동기 전환 (우선순위: 높음)**: `spdlog::async_factory`를 사용하여 비동기 로거를 생성하는 중앙화된 초기화 함수를 구현해야 합니다. 이를 통해 로깅 작업이 백그라운드 스레드에서 처리되도록 하여, 애플리케이션의 메인 스레드가 블로킹되는 것을 방지할 수 있습니다.
2.  **로깅 설정 중앙화**: 애플리케이션 시작점(`main.cpp`)에서 단일 로거 인스턴스를 설정하고, 프로젝트 전반에서 이 인스턴스를 사용하도록 구조를 변경해야 합니다.

---

### 3. 데이터스토어 (DataStore)

#### 3.1. 현황 분석

`DataStore` 모듈(`src/core/datastore`)은 `GEMINI.md` 개발 가이드라인에 명시된 문제점들을 성공적으로 해결한, 매우 성숙하고 안정적인 아키텍처를 보여줍니다.

- **동시성 및 성능**:
  - `tbb::concurrent_hash_map`을 핵심 데이터 저장소로 사용하여, 과거의 전역 뮤텍스 병목 현상(이슈 #002)을 완벽하게 해결했습니다.
  - `tbb::accessor`를 통한 데이터 접근은 스레드 안전성과 RAII 원칙을 철저히 준수합니다.

- **메모리 관리**:
  - Observer 패턴 구현에 `std::weak_ptr`를 사용하여 순환 참조 및 댕글링 포인터 문제(이슈 #003)를 원천적으로 방지합니다.
  - `notify` 메서드 내에서 파괴된 Observer를 자동으로 정리하여 메모리 누수를 방지합니다.

- **테스트 용이성**:
  - `createForTest()` 팩토리 메서드를 제공하여 단위 테스트 간 상태 격리를 보장합니다. 이는 싱글톤 패턴의 고질적인 테스트 문제(이슈 #004)를 해결한 모범적인 설계입니다.

#### 3.2. 긍정적 평가

`DataStore`는 과거에 식별된 주요 아키텍처 문제들을 성공적으로 리팩토링한 모범 사례입니다. 현재의 설계는 성능, 안정성, 테스트 용이성 측면에서 매우 우수합니다.

#### 3.3. 추가 개선 제안 (낮은 우선순위)

- **세분화된 뮤텍스**: 현재 `notifiers_`, `expiration_policies_` 등 메타데이터를 보호하는 단일 뮤텍스(`mutex_`)가 존재합니다. 만약 향후 이 부분에서 경합이 측정된다면, 각 멤버별로 별도의 뮤텍스를 도입하는 것을 고려할 수 있습니다.
- **`std::atomic` 기반 메트릭**: 성능 메트릭 업데이트 시 뮤텍스 대신 `std::atomic`을 사용하면, 락 없이(lock-free) 카운터를 조작할 수 있어 아주 미세한 성능 향상을 기대할 수 있습니다.

---

### 4. 최종 결론 및 다음 단계

- **결론**: `DataStore` 모듈은 현재 매우 안정적이고 우수한 아키텍처를 가지고 있습니다. 반면, **로깅 시스템의 동기식 `spdlog` 사용**은 잠재적인 성능 병목 지점으로, 시스템 안정성을 위해 개선이 필요합니다.
- **다음 단계**: `spdlog`를 비동기 방식으로 전환하고 설정을 중앙화하기 위한 공식 이슈를 생성하여 조치를 취합니다.
