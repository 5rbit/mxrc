# 기능 사양서: 상태 관리 (State Management)

**기능 브랜치**: `012-state-management`
**생성일**: 2025년 11월 3일
**상태**: 초안
**입력**: 사용자 설명: "개발사양서.md에 2.7항알람핸들러 부터 2항 끝까지 내용을 new-feature로 사양을 각각 만들어줘"

## 사용자 시나리오 및 테스트

### 사용자 스토리 1 - 로봇의 운영 상태 확인 및 이해 (우선순위: P1)

시스템 운영자는 로봇의 현재 운영 상태(BOOT, MANUAL, AUTOREADY, AUTO, PAUSE, AVOIDANCE_PAUSED, DEADLOCK, FAULT, ESTOP 등)를 명확하게 확인하고, 각 상태가 로봇의 동작에 어떤 영향을 미치는지 이해할 수 있어야 합니다.

**이 우선순위인 이유**: 로봇의 현재 상태를 정확히 파악하는 것은 운영자가 로봇의 동작을 예측하고 적절히 제어하는 데 필수적입니다.

**독립 테스트**: 로봇이 다양한 운영 시나리오(예: 임무 시작, 일시 정지, 장애물 회피, 오류 발생)를 거칠 때, GUI에 표시되는 상태가 실제 로봇의 동작과 일치하는지 확인할 수 있습니다.

**인수 시나리오**:

1.  **주어진 상황** 로봇이 임무를 시작하면, **언제** 로봇의 상태가 AUTO로 전환되고, **그러면** GUI에 AUTO 상태가 명확하게 표시됩니다.
2.  **주어진 상황** 로봇이 장애물을 감지하여 회피 동작을 수행하면, **언제** 로봇의 상태가 AVOIDANCE_PAUSED로 전환되고, **그러면** GUI에 AVOIDANCE_PAUSED 상태가 표시됩니다.

---

### 사용자 스토리 2 - 상태 천이의 명확성 및 안정성 보장 (우선순위: P1)

시스템은 로봇의 상태 천이(Transition)가 명확한 조건(DataStore의 실시간 데이터 기반)에 따라 안정적으로 이루어져야 하며, 특히 AVOIDANCE_PAUSED 상태에서 Deadlock 타이머 만료 시 DEADLOCK 상태로 자동 천이하는 로직이 올바르게 동작해야 합니다.

**이 우선순위인 이유**: 상태 천이의 안정성은 로봇의 예측 가능한 동작과 시스템의 신뢰성을 보장하는 데 매우 중요합니다. 잘못된 상태 천이는 로봇의 오작동이나 안전 문제로 이어질 수 있습니다.

**독립 테스트**: 특정 상태 천이 조건(예: Safety 알람 발생, 배터리 부족)을 시뮬레이션하여 로봇의 상태가 의도한 대로 전환되는지 확인하고, AVOIDANCE_PAUSED 상태에서 Deadlock 타이머가 만료되었을 때 DEADLOCK 상태로 정확히 전환되는지 검증할 수 있습니다.

**인수 시나리오**:

1.  **주어진 상황** 로봇이 AVOIDANCE_PAUSED 상태에 진입하고, **언제** 지정된 Deadlock 타이머가 만료되면, **그러면** 로봇의 상태는 자동으로 DEADLOCK으로 천이됩니다.
2.  **주어진 상황** 로봇이 AUTOREADY 상태에서 임무 시작 명령을 받으면, **언제** DataStore의 임무 시작 조건이 충족되면, **그러면** 로봇의 상태는 AUTO로 전환됩니다.

---

### 사용자 스토리 3 - 계층적 상태 관리를 통한 복잡도 관리 (우선순위: P2)

복잡한 AUTO 상태 내부에서 DRIVING, LOADING 등 세부 동작을 관리하는 계층적 상태 머신(Sub-States) 구조를 통해 로봇의 복잡한 동작을 체계적으로 관리하고 이해할 수 있어야 합니다.

**이 우선순위인 이유**: 계층적 상태 관리는 복잡한 로봇 동작의 설계, 구현 및 디버깅을 용이하게 하여 시스템의 유지보수성을 높입니다.

**독립 테스트**: AUTO 상태 내에서 DRIVING, LOADING과 같은 서브 상태들이 올바르게 천이되고, 각 서브 상태에서 정의된 동작이 정확히 수행되는지 확인할 수 있습니다.

**인수 시나리오**:

1.  **주어진 상황** 로봇이 AUTO 상태에서 주행 임무를 시작하면, **언제** DRIVING 서브 상태로 진입하고, **그러면** 로봇은 주행 동작을 수행합니다.

---

### 엣지 케이스

- 동시에 여러 상태 천이 조건이 충족될 경우 어떤 상태로 우선적으로 천이됩니까?
- 상태 천이 중 시스템 오류가 발생하면 로봇은 어떤 상태로 전환됩니까?
- 리소스 관리(enterState/exitState) 로직에서 오류가 발생하면 시스템은 어떻게 처리됩니까?

## 요구사항

### 기능적 요구사항

-   **FR-001**: 시스템은 State 디자인 패턴을 적용하여 각 운영 상태별 로직을 독립적으로 캡슐화해야 합니다.
-   **FR-002**: 시스템 초기화(BOOT), 수동 조작(MANUAL), 임무 대기(AUTOREADY), 자율 임무 실행(AUTO), 일시 정지(PAUSE), 회피 일시 정지(AVOIDANCE_PAUSED), 교착 상태(DEADLOCK), 오류(FAULT), 비상 정지(ESTOP) 등의 최상위 운영 상태를 정의해야 합니다.
-   **FR-003**: 상태 천이 조건은 중앙 DataStore의 실시간 데이터(Safety, Alarm, Battery Level, AvoidReq 상태 등)를 기반으로 결정되어야 합니다.
-   **FR-004**: Change Notifier (Observer 패턴)를 통해 DataStore의 데이터 변경에 즉각적으로 반응하여 상태 천이를 수행해야 합니다.
-   **FR-005**: AVOIDANCE_PAUSED 상태에서 지정된 Deadlock 타이머 만료 시 DEADLOCK 상태로 자동 천이하는 로직을 포함해야 합니다.
-   **FR-006**: 복잡한 AUTO 상태 내부에는 DRIVING, LOADING 등 세부 동작을 관리하는 계층적 상태 머신(Sub-States) 구조를 도입해야 합니다.
-   **FR-007**: 모든 상태는 진입(enterState) 및 이탈(exitState) 시 해당 상태에서 사용한 리소스를 안전하게 활성화 및 정지/정리하는 의무 사항을 가져야 합니다.

### 주요 엔티티

-   **RobotState**: 로봇의 현재 운영 상태를 나타내는 열거형 또는 클래스 (BOOT, MANUAL, AUTOREADY, AUTO, PAUSE, AVOIDANCE_PAUSED, DEADLOCK, FAULT, ESTOP 등).
-   **StateMachine**: 로봇의 상태 천이를 관리하는 모듈.
-   **DataStore**: 로봇의 실시간 데이터를 저장하고 상태 천이 조건의 기반이 되는 중앙 데이터 저장소.

## 성공 기준

### 측정 가능한 결과

-   **SC-001**: 로봇의 상태 천이는 0.5초 이내에 완료되며, GUI에 정확하게 반영됩니다.
-   **SC-002**: AVOIDANCE_PAUSED 상태에서 Deadlock 타이머 만료 시 1초 이내에 DEADLOCK 상태로 자동 천이됩니다.
-   **SC-003**: 계층적 상태 머신 내의 서브 상태 천이는 0.2초 이내에 완료됩니다.
-   **SC-004**: 상태 진입/이탈 시 리소스 활성화/정리 과정에서 발생하는 지연 시간은 100ms를 초과하지 않습니다.