# 기능 사양서: Over-The-Air (OTA) 업데이트 및 펌웨어 관리 (OTA Update & Firmware Management)

**기능 브랜치**: `013-ota-update-firmware-management`
**생성일**: 2025년 11월 3일
**상태**: 초안
**입력**: 사용자 설명: "개발사양서.md에 2.7항알람핸들러 부터 2항 끝까지 내용을 new-feature로 사양을 각각 만들어줘"

## 사용자 시나리오 및 테스트

### 사용자 스토리 1 - 안전하고 안정적인 펌웨어 업데이트 (우선순위: P1)

시스템 관리자는 로봇의 펌웨어를 A/B Dual Partition 기반의 OTA(Over-The-Air) 방식으로 안전하고 안정적으로 업데이트할 수 있어야 합니다. 업데이트 과정에서 패키지의 보안 무결성이 검증되어야 하며, 업데이트 실패 시 자동으로 이전 버전으로 롤백되어 로봇의 운영 연속성이 보장되어야 합니다.

**이 우선순위인 이유**: 펌웨어 업데이트는 로봇의 기능 개선 및 버그 수정에 필수적이며, 이 과정의 안정성과 보안은 로봇의 신뢰성 및 안전 운행에 직접적인 영향을 미칩니다.

**독립 테스트**: 새로운 펌웨어 패키지를 배포한 후, 로봇이 안전 영역으로 이동하여 업데이트를 진행하고, 업데이트 성공 시 새로운 펌웨어로 정상 부팅되는지, 실패 시 이전 펌웨어로 자동 롤백되는지 확인할 수 있습니다.

**인수 시나리오**:

1.  **주어진 상황** 새로운 펌웨어 업데이트가 배포되었고, **언제** 시스템 관리자가 GUI를 통해 로봇에 업데이트를 명령하면, **그러면** 로봇은 PAUSE 또는 AUTOREADY 상태로 전환된 후 업데이트를 진행하고, 성공적으로 업데이트된 펌웨어로 재부팅됩니다.
2.  **주어진 상황** 펌웨어 업데이트 중 오류가 발생하면, **언제** 로봇이 재부팅을 시도하면, **그러면** Boot Loader는 자동으로 이전의 유효한 파티션으로 롤백하고, 롤백 상태를 LogModule에 기록합니다.

---

### 사용자 스토리 2 - GUI 기반 펌웨어 업로드 및 상태 모니터링 (우선순위: P2)

시스템 관리자는 GUI의 전용 OTA View를 통해 펌웨어 파일을 직접 업로드하고, OTA 진행률, 현재 버전, 대상 버전, 설치/검증 성공 여부, 롤백 상태 등 모든 업데이트 단계를 실시간으로 모니터링할 수 있어야 합니다.

**이 우선순위인 이유**: GUI를 통한 직관적인 펌웨어 관리 및 실시간 상태 모니터링은 관리자의 편의성을 높이고, 업데이트 과정의 투명성을 제공합니다.

**독립 테스트**: GUI를 통해 펌웨어 파일을 업로드하고, OTA 진행 상황이 GUI에 실시간으로 정확하게 표시되는지 확인할 수 있습니다.

**인수 시나리오**:

1.  **주어진 상황** 시스템 관리자가 GUI의 OTA View에서 펌웨어 파일을 업로드하면, **언제** 로봇이 업데이트를 진행하면, **그러면** GUI에 다운로드 진행률, 설치 상태, 검증 성공 여부 등 OTA의 모든 단계가 실시간으로 표시됩니다.

---

### 사용자 스토리 3 - 권한 기반 업데이트 및 단계별 배포 (우선순위: P3)

OTA 실행은 RBAC(Role-Based Access Control)에 의해 보호되어 지정된 관리자만 실행할 수 있도록 통제되어야 합니다. 또한, 단계별 배포(Staged Rollout) 전략을 지원하여 일부 로봇에 먼저 업데이트를 적용하고 안정성을 검증할 수 있어야 합니다.

**이 우선순위인 이유**: 펌웨어 업데이트는 로봇의 핵심 기능을 변경하므로, 보안 및 안정적인 배포를 위해 권한 관리 및 단계별 배포 전략이 필요합니다.

**독립 테스트**: 관리자 권한이 없는 사용자가 OTA 업데이트를 시도했을 때 거부되는지, 그리고 특정 그룹의 로봇에만 업데이트를 배포했을 때 해당 로봇들만 업데이트가 진행되는지 확인할 수 있습니다.

**인수 시나리오**:

1.  **주어진 상황** 일반 운영자 권한을 가진 사용자가 OTA 업데이트를 시도하면, **언제** 시스템이 권한을 확인하면, **그러면** 업데이트 요청이 거부됩니다.
2.  **주어진 상황** 시스템 관리자가 특정 로봇 그룹에만 업데이트를 배포하도록 설정하면, **언제** 업데이트가 시작되면, **그러면** 해당 그룹의 로봇들만 업데이트를 진행합니다.

---

### 엣지 케이스

- 펌웨어 패키지 다운로드 중 네트워크 연결이 끊기면 어떻게 처리됩니까?
- 디지털 서명 검증에 실패한 패키지를 설치하려고 시도하면 어떻게 처리됩니까?
- 업데이트 중 로봇이 안전 영역으로 이동할 수 없는 상황(예: 경로 막힘)이 발생하면 어떻게 처리됩니까?

## 요구사항

### 기능적 요구사항

-   **FR-001**: 시스템은 A/B Dual Partition 기반의 안전한 업데이트 환경을 구현해야 합니다.
-   **FR-002**: HTTP API를 통한 패키지 다운로드 및 디지털 서명(Digital Signature) 검증 전략을 포함하여 보안 및 무결성을 극대화해야 합니다.
-   **FR-003**: 업데이트 중 로봇은 안전 영역으로 이동하여 임무를 정지(PAUSE 또는 AUTOREADY 상태)한 후 진행되어야 합니다.
-   **FR-004**: MissionManager와 StateMachine은 OTA 상태를 실시간으로 인지해야 합니다.
-   **FR-005**: 다운로드된 펌웨어 패키지에 대해 SHA-256 해시 검증과 더불어, ECDSA 또는 RSA 기반의 디지털 서명 검증을 필수적으로 수행하여 패키지의 변조 및 위변조 여부를 확인해야 합니다.
-   **FR-006**: 업데이트된 펌웨어로 부팅(BOOT 상태)한 후, 시스템 핵심 기능(Main Control Loop, 통신, 센서 초기화)에 대한 부팅 후 건전성 검사(Post-Boot Health Check)를 수행해야 합니다.
-   **FR-007**: 부팅 후 건전성 검사 실패 시, Boot Loader는 자동으로 이전의 유효한 파티션으로 롤백해야 하며, 롤백 상태를 LogModule에 기록해야 합니다.
-   **FR-008**: 운영자가 GUI의 전용 OTA View를 통해 펌웨어 파일을 직접 업로드(HTTP POST 또는 Web Socket 기반 파일 전송)할 수 있어야 합니다.
-   **FR-009**: OTA 진행률, 현재 버전, 대상 버전, 설치/검증 성공 여부, 롤백 상태 등 모든 단계는 DataStore에 저장되고 상위 시스템 및 GUI에 실시간으로 보고되어야 합니다.
-   **FR-010**: OTA 실행은 RBAC(Role-Based Access Control)에 의해 보호되어야 하며, 지정된 관리자만 실행할 수 있도록 통제해야 합니다.
-   **FR-011**: 단계별 배포(Staged Rollout) 전략을 지원할 수 있도록 설계하여, 일부 로봇에 먼저 업데이트를 적용하고 안정성을 검증하는 기능을 제공해야 합니다.

### 주요 엔티티

-   **FirmwarePackage**: 업데이트될 펌웨어 파일 및 관련 메타데이터(버전, 디지털 서명 등).
-   **OTAManager**: OTA 업데이트 프로세스를 총괄 관리하는 모듈.
-   **BootLoader**: 펌웨어 부팅 및 롤백을 담당하는 모듈.
-   **OTAReport**: OTA 진행 상태 및 결과에 대한 정보.

## 성공 기준

### 측정 가능한 결과

-   **SC-001**: 펌웨어 업데이트 성공률은 99.9% 이상을 유지합니다.
-   **SC-002**: 펌웨어 업데이트 실패 시 10초 이내에 이전 유효한 펌웨어로 자동 롤백됩니다.
-   **SC-003**: GUI를 통한 펌웨어 업로드 및 업데이트 상태 모니터링 정보는 1초 이내에 실시간으로 업데이트됩니다.
-   **SC-004**: OTA 업데이트 과정에서 로봇의 비계획적 다운타임은 발생하지 않습니다.