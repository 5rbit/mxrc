# HA Policy Configuration for MXRC
# Feature: 019-architecture-improvements
# Version: 1.0.0
# Date: 2025-01-23
#
# 이 파일은 High Availability(HA) 상태 머신의 복구 정책을 정의합니다.
# HAStateMachine 클래스가 이 파일을 로드하여 장애 유형별 복구 전략을 실행합니다.

---
ha_policy_version: "1.0.0"

# =============================================================================
# HA 상태 정의
# =============================================================================
states:
  NORMAL:
    description: "정상 동작 상태, 모든 기능이 정상적으로 작동"
    entry_actions: []
    exit_actions: []
    monitoring:
      - heartbeat_check
      - deadline_monitoring
      - resource_monitoring

  DEGRADED:
    description: "일부 기능 저하 상태, 경미한 오류 발생 중이지만 주요 기능은 정상"
    entry_actions:
      - log_warning
      - notify_operator
    exit_actions: []
    monitoring:
      - increased_heartbeat_check
      - detailed_error_logging

  SAFE_MODE:
    description: "안전 모드, 모든 모터 정지, 센서 모니터링만 유지"
    entry_actions:
      - stop_all_motors
      - transition_fieldbus_to_safe_op
      - log_critical
      - send_alert
    exit_actions:
      - verify_safe_to_exit
    monitoring:
      - continuous_heartbeat_check
      - safety_system_monitoring

  RECOVERY_IN_PROGRESS:
    description: "복구 진행 중, 자동 복구 액션 실행 중"
    entry_actions:
      - log_info
      - increment_recovery_attempt
    exit_actions:
      - reset_recovery_attempt_on_success
    monitoring:
      - recovery_timeout_check
      - recovery_progress_monitoring

  MANUAL_INTERVENTION:
    description: "수동 개입 필요, 자동 복구 실패 또는 알 수 없는 장애"
    entry_actions:
      - stop_all_motors
      - log_critical
      - send_urgent_alert
      - create_incident_report
    exit_actions:
      - verify_manual_clearance
    monitoring:
      - wait_for_operator_command

  SHUTDOWN:
    description: "시스템 종료, 복구 불가능 상태 또는 관리자 명령"
    entry_actions:
      - stop_all_processes
      - save_state_to_disk
      - log_shutdown_reason
    exit_actions: []
    monitoring: []

# =============================================================================
# 상태 전이 규칙
# =============================================================================
state_transitions:
  # NORMAL 상태에서의 전이
  - from: NORMAL
    to: DEGRADED
    conditions:
      - type: sensor_communication_failure
        threshold: 1
        window_ms: 1000
      - type: minor_error_rate
        threshold: 5
        window_ms: 5000
    description: "경미한 오류 발생 시 DEGRADED 상태로 전이"

  - from: NORMAL
    to: RECOVERY_IN_PROGRESS
    conditions:
      - type: rt_process_crash
      - type: nonrt_process_crash
      - type: heartbeat_timeout
    description: "일반 장애 발생 시 복구 진행"

  - from: NORMAL
    to: SAFE_MODE
    conditions:
      - type: deadline_miss_consecutive
        threshold: 3
      - type: ethercat_comm_failure
      - type: motor_overcurrent
    description: "치명적 장애 발생 시 즉시 안전 모드 진입"

  # DEGRADED 상태에서의 전이
  - from: DEGRADED
    to: NORMAL
    conditions:
      - type: error_cleared
        duration_ms: 10000
    description: "오류 해결 시 정상 상태 복귀"

  - from: DEGRADED
    to: RECOVERY_IN_PROGRESS
    conditions:
      - type: error_escalation
      - type: multiple_failures
        threshold: 3
        window_ms: 30000
    description: "오류 악화 시 복구 프로세스 시작"

  # RECOVERY_IN_PROGRESS 상태에서의 전이
  - from: RECOVERY_IN_PROGRESS
    to: NORMAL
    conditions:
      - type: recovery_success
    description: "복구 성공 시 정상 상태 복귀"

  - from: RECOVERY_IN_PROGRESS
    to: MANUAL_INTERVENTION
    conditions:
      - type: recovery_attempt_exceeded
        threshold: 3
      - type: recovery_timeout
        timeout_ms: 30000
    description: "복구 시도 실패 시 수동 개입 필요"

  - from: RECOVERY_IN_PROGRESS
    to: SAFE_MODE
    conditions:
      - type: critical_failure_during_recovery
    description: "복구 중 치명적 장애 발생 시 안전 모드 진입"

  # SAFE_MODE 상태에서의 전이
  - from: SAFE_MODE
    to: RECOVERY_IN_PROGRESS
    conditions:
      - type: operator_initiated_recovery
      - type: automatic_recovery_after_delay
        delay_ms: 60000
    description: "안전 모드에서 복구 시도"

  - from: SAFE_MODE
    to: MANUAL_INTERVENTION
    conditions:
      - type: additional_failure_in_safe_mode
      - type: recovery_not_possible
    description: "안전 모드에서 추가 장애 발생 시"

  # MANUAL_INTERVENTION 상태에서의 전이
  - from: MANUAL_INTERVENTION
    to: NORMAL
    conditions:
      - type: operator_cleared_all_errors
      - type: system_health_verified
    description: "관리자 개입 후 정상 복귀"

  - from: MANUAL_INTERVENTION
    to: SHUTDOWN
    conditions:
      - type: operator_commanded_shutdown
      - type: unrecoverable_failure
    description: "관리자 판단으로 시스템 종료"

# =============================================================================
# 장애 유형별 복구 정책
# =============================================================================
recovery_policies:
  rt_process_crash:
    action: RESTART_RT_PROCESS
    max_attempts: 3
    retry_delay_ms: 5000
    description: "RT 프로세스 크래시 시 자동 재시작 (최대 3회)"
    escalation:
      - condition: max_attempts_exceeded
        next_action: NOTIFY_AND_WAIT

  nonrt_process_crash:
    action: RESTART_NONRT_PROCESS
    max_attempts: 3
    retry_delay_ms: 3000
    description: "Non-RT 프로세스 크래시 시 자동 재시작"
    escalation:
      - condition: max_attempts_exceeded
        next_action: RESTART_BOTH_PROCESSES

  heartbeat_timeout:
    action: RESTART_BOTH_PROCESSES
    max_attempts: 2
    retry_delay_ms: 10000
    description: "하트비트 타임아웃 시 양쪽 프로세스 재시작"
    escalation:
      - condition: max_attempts_exceeded
        next_action: ENTER_SAFE_MODE

  deadline_miss_consecutive:
    action: ENTER_SAFE_MODE
    max_attempts: 1
    retry_delay_ms: 0
    description: "연속 Deadline Miss 시 즉시 안전 모드 진입 (복구 시도 없음)"
    escalation:
      - condition: safe_mode_failure
        next_action: NOTIFY_AND_WAIT

  ethercat_comm_failure:
    action: ENTER_SAFE_MODE
    max_attempts: 1
    retry_delay_ms: 0
    description: "EtherCAT 통신 실패 시 즉시 안전 모드 진입"
    escalation:
      - condition: safe_mode_failure
        next_action: EMERGENCY_SHUTDOWN

  sensor_failure:
    action: PARTIAL_RESTART
    max_attempts: 2
    retry_delay_ms: 5000
    description: "센서 고장 시 센서 드라이버 재시작"
    partial_restart_targets:
      - sensor_driver
      - data_acquisition
    escalation:
      - condition: max_attempts_exceeded
        next_action: NOTIFY_AND_WAIT

  datastore_corruption:
    action: NOTIFY_AND_WAIT
    max_attempts: 1
    retry_delay_ms: 0
    description: "DataStore 데이터 손상 시 수동 개입 필요 (자동 복구 불가)"
    escalation:
      - condition: operator_timeout
        timeout_ms: 300000
        next_action: EMERGENCY_SHUTDOWN

  memory_exhaustion:
    action: EMERGENCY_SHUTDOWN
    max_attempts: 1
    retry_delay_ms: 0
    description: "메모리 부족 시 긴급 종료 (데이터 손실 방지)"
    escalation: []

  motor_overcurrent:
    action: ENTER_SAFE_MODE
    max_attempts: 1
    retry_delay_ms: 0
    description: "모터 과전류 감지 시 즉시 안전 모드 진입"
    escalation:
      - condition: safe_mode_failure
        next_action: EMERGENCY_SHUTDOWN

  fieldbus_state_error:
    action: PARTIAL_RESTART
    max_attempts: 3
    retry_delay_ms: 5000
    description: "필드버스 상태 오류 시 필드버스 드라이버 재시작"
    partial_restart_targets:
      - fieldbus_driver
    escalation:
      - condition: max_attempts_exceeded
        next_action: ENTER_SAFE_MODE

# =============================================================================
# 복구 액션 정의
# =============================================================================
recovery_actions:
  RESTART_RT_PROCESS:
    command: "systemctl restart mxrc-rt"
    timeout_ms: 15000
    verification:
      - check_process_running
      - check_heartbeat_resumed
      - verify_datastore_connection
    rollback_on_failure: false

  RESTART_NONRT_PROCESS:
    command: "systemctl restart mxrc-nonrt"
    timeout_ms: 10000
    verification:
      - check_process_running
      - check_heartbeat_resumed
      - verify_eventbus_connection
    rollback_on_failure: false

  RESTART_BOTH_PROCESSES:
    command: "systemctl restart mxrc-rt mxrc-nonrt"
    timeout_ms: 20000
    verification:
      - check_both_processes_running
      - check_ipc_communication
      - verify_fieldbus_operational
    rollback_on_failure: false

  ENTER_SAFE_MODE:
    steps:
      - action: stop_all_motors
        timeout_ms: 1000
      - action: transition_fieldbus_to_safe_op
        timeout_ms: 2000
      - action: disable_non_critical_tasks
        timeout_ms: 500
      - action: enable_safety_monitoring_only
        timeout_ms: 500
    verification:
      - verify_motors_stopped
      - verify_safe_op_state
    rollback_on_failure: false

  PARTIAL_RESTART:
    steps:
      - action: stop_target_component
        timeout_ms: 3000
      - action: reinitialize_component
        timeout_ms: 5000
      - action: verify_component_health
        timeout_ms: 2000
    verification:
      - verify_component_operational
    rollback_on_failure: true

  NOTIFY_AND_WAIT:
    notification:
      - type: email
        recipients: ["admin@example.com", "ops@example.com"]
        subject: "MXRC: Manual Intervention Required"
        priority: urgent
      - type: slack
        channel: "#mxrc-alerts"
        message: "System in MANUAL_INTERVENTION state. Immediate action required."
      - type: sms
        recipients: ["+82-10-1234-5678"]
        message: "MXRC: Critical failure, manual intervention needed."
    timeout_ms: 300000  # 5분 대기
    verification: []

  EMERGENCY_SHUTDOWN:
    steps:
      - action: stop_all_motors
        timeout_ms: 1000
        force: true
      - action: save_system_state
        timeout_ms: 3000
        target: "/var/log/mxrc/emergency_state.json"
      - action: stop_all_processes
        timeout_ms: 5000
        command: "systemctl stop mxrc-rt mxrc-nonrt"
      - action: create_crash_dump
        timeout_ms: 10000
        target: "/var/log/mxrc/crash_dump_{timestamp}.tar.gz"
    verification: []
    rollback_on_failure: false

# =============================================================================
# 임계값 및 타이머 설정
# =============================================================================
thresholds:
  # 하트비트 설정
  heartbeat_interval_ms: 1000
  heartbeat_timeout_ms: 5000
  heartbeat_miss_threshold: 3

  # Deadline Miss 설정
  deadline_miss_threshold: 3
  deadline_miss_window_ms: 10000

  # 복구 설정
  max_recovery_attempts: 3
  recovery_timeout_ms: 30000
  safe_mode_timeout_ms: 60000

  # 리소스 모니터링
  cpu_usage_warning_threshold: 80.0
  cpu_usage_critical_threshold: 95.0
  memory_usage_warning_threshold: 85.0
  memory_usage_critical_threshold: 95.0

  # EventBus 큐
  eventbus_queue_size_warning: 800
  eventbus_queue_size_critical: 950

  # EtherCAT
  ethercat_working_counter_error_threshold: 5
  ethercat_comm_failure_window_ms: 3000

# =============================================================================
# 로깅 및 모니터링 설정
# =============================================================================
logging:
  state_transitions:
    enabled: true
    level: INFO
    include_stack_trace: false
    target: "/var/log/mxrc/ha_state_transitions.log"

  recovery_actions:
    enabled: true
    level: INFO
    include_timing: true
    target: "/var/log/mxrc/ha_recovery_actions.log"

  failures:
    enabled: true
    level: ERROR
    include_stack_trace: true
    include_system_state: true
    target: "/var/log/mxrc/ha_failures.log"

monitoring:
  metrics_export:
    enabled: true
    prometheus_port: 9091
    metrics:
      - ha_state_transitions_total
      - ha_recovery_attempts_total
      - ha_recovery_success_total
      - ha_recovery_failure_total
      - ha_time_in_state_seconds

  alerting:
    enabled: true
    alert_on_state_change: true
    alert_on_recovery_failure: true
    alert_channels:
      - email
      - slack
      - prometheus_alertmanager

# =============================================================================
# 시뮬레이션 및 테스트 설정
# =============================================================================
testing:
  enable_failure_injection: false
  simulated_failures:
    - type: rt_process_crash
      probability: 0.0
      interval_ms: 60000
    - type: deadline_miss_consecutive
      probability: 0.0
      interval_ms: 30000

  dry_run_mode:
    enabled: false
    description: "Dry run 모드에서는 복구 액션을 로깅만 하고 실제 실행하지 않음"
    log_target: "/var/log/mxrc/ha_dry_run.log"
