# 기능 사양서: Safety & Collision Avoidance (안전 및 충돌 방지)

**기능 브랜치**: `003-safety-collision-avoidance`
**생성일**: 2025-11-03
**상태**: 초안
**입력**: 사용자 설명: "2.2. Safety & Collision Avoidance (안전 및 충돌 방지)..."

## 사용자 시나리오 및 테스트 *(필수)*

### 사용자 스토리 1 - 다단계 안전 필드를 통한 충돌 방지 (우선순위: P1)

로봇은 LDS 센서를 사용하여 3단계(경고, 제어 정지, 비상 정지)의 안전 필드를 동적으로 설정하고, 각 단계별로 정의된 대응 액션을 수행하여 충돌을 방지해야 합니다.

**이 우선순위인 이유**: 작업자의 안전을 보장하고 로봇 및 주변 설비의 손상을 방지하는 가장 중요한 기능입니다.

**독립 테스트**: 시뮬레이션 환경에서 다양한 속도와 각도로 장애물을 로봇 경로에 진입시켜, 각 안전 필드 단계별로 로봇이 올바르게 (경고, 감속, 정지) 반응하는지 검증할 수 있습니다.

**인수 시나리오**:

1.  **주어진 상황** 로봇이 주행 중일 때, **언제** 장애물이 경고 구역(Warning Field)에 진입하면, **그러면** 시스템은 경고 알람을 발생시키고 주행 속도를 유지해야 합니다.
2.  **주어진 상황** 로봇이 주행 중일 때, **언제** 장애물이 제어 정지 구역(Controlled Stop Field)에 진입하면, **그러면** 로봇은 안전하게 감속하여 정지하고, `AVOIDANCE_PAUSED` 상태로 전환해야 합니다.
3.  **주어진 상황** 로봇이 주행 중일 때, **언제** 장애물이 비상 정지 구역(Emergency Stop Field)에 진입하면, **그러면** 로봇은 즉시 비상 정지하고 `FAULT` 또는 `ESTOP` 상태로 전환해야 합니다.

---

### 사용자 스토리 2 - 장애물 회피 후 자동 임무 재개 (우선순위: P2)

로봇이 장애물로 인해 일시 정지(`AVOIDANCE_PAUSED`)했을 때, 장애물이 사라지면 자동으로 이전에 수행하던 임무를 재개해야 합니다.

**이 우선순위인 이유**: 시스템의 자율성과 운영 효율성을 높입니다.

**독립 테스트**: 로봇을 장애물로 인해 정지시킨 후, 장애물을 제거했을 때 로봇이 설정된 시간 내에 자동으로 임무를 재개하는지 확인할 수 있습니다.

**인수 시나리오**:

1.  **주어진 상황** 로봇이 `AVOIDANCE_PAUSED` 상태일 때, **언제** 장애물이 사라지고 안전 필드가 500ms 동안 깨끗하게 유지되면, **그러면** 로봇은 이전에 수행하던 `AUTO` 상태로 복귀하여 임무를 재개해야 합니다.
2.  **주어진 상황** 로봇이 `AVOIDANCE_PAUSED` 상태로 60초 이상 머무르면, **언제** Deadlock 타이머가 만료되면, **그러면** 시스템은 `DEADLOCK` 상태로 전환하고 Critical 알람을 발생시켜야 합니다.

---

### 엣지 케이스

- 투명하거나 검은색과 같이 LDS 센서가 감지하기 어려운 장애물은 어떻게 처리합니까?
- 여러 로봇이 서로를 장애물로 인식하여 교착 상태(Deadlock)에 빠지는 경우를 어떻게 해결합니까?

## 요구사항 *(필수)*

### 기능적 요구사항

- **FR-001**: 시스템은 ISO 3691-4 표준을 준수하는 안전 정지 로직(STO, ESTOP, Area Stop)을 구현해야 합니다.
- **FR-002**: 시스템은 LDS 센서 데이터를 기반으로 3단계(경고, 제어 정지, 비상 정지)의 안전 필드를 구현해야 합니다.
- **FR-003**: 안전 필드의 범위는 로봇의 속도에 따라 동적으로 조절되어야 합니다.
- **FR-004**: 제어 정지 구역 침범 시, 시스템은 상위 시스템에 `AvoidReq` 메시지를 보고하고 `AVOIDANCE_PAUSED` 상태로 전환해야 합니다.
- **FR-005**: 장애물 제거 시, 시스템은 자동으로 이전 임무를 재개해야 합니다.
- **FR-006**: 회피 상태가 지정된 시간 이상 지속될 경우, 시스템은 `DEADLOCK` 상태로 전환해야 합니다.
- **FR-007**: 시스템은 UWB/BLE 통신을 통해 수신된 다른 로봇의 정보를 활용하여 협업 기반 충돌 방지 로직을 제공해야 합니다.
- **FR-008**: 시스템은 LDS, Encoder 등 안전 관련 센서의 오염, 오류, 통신 이상을 감지하고 알람을 발생시켜야 합니다.

### 주요 엔티티

- **SafetyController**: 안전 관련 로직을 총괄하는 모듈. Safety PLC 또는 Safety Controller와 연동합니다.
- **LDS (Laser Distance Sensor)**: 장애물 감지를 위한 핵심 센서입니다.
- **StateMachine**: 로봇의 안전 상태(`AVOIDANCE_PAUSED`, `DEADLOCK`, `FAULT`, `ESTOP`)를 관리합니다.
- **MessageBus**: 모듈 간 비동기 메시지(e.g., `AvoidReq`, `AVOID_CLEAR`)를 전달합니다.

## 성공 기준 *(필수)*

### 측정 가능한 결과

- **SC-001**: 시스템은 ISO 3691-4 안전 표준의 관련 요구사항을 충족해야 합니다.
- **SC-002**: 모든 안전 필드 시나리오(경고, 제어 정지, 비상 정지)가 100%의 성공률로 시뮬레이션 및 실제 테스트를 통과해야 합니다.
- **SC-003**: 장애물 회피 후 임무 재개까지 걸리는 시간은 1초 이내여야 합니다.
- **SC-004**: Deadlock 감지 및 상태 전환은 설정된 시간(예: 60초) 내에 정확하게 이루어져야 합니다.
