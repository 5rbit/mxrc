# 기능 사양서: Interface & Peripherals (인터페이스 및 주변 장치)

**기능 브랜치**: `005-interface-peripherals`
**생성일**: 2025-11-03
**상태**: 초안
**입력**: 사용자 설명: "2.4. Interface & Peripherals..."

## 사용자 시나리오 및 테스트 *(필수)*

### 사용자 스토리 1 - 상위 제어기(WCS)와의 안정적인 통신 (우선순위: P1)

로봇은 상위 제어기(WCS)와 안정적으로 통신하고, 통신 실패 시 자동으로 재연결을 시도하며, 재연결 실패 시 인접 로봇을 통해 명령을 릴레이받아야 합니다.

**이 우선순위인 이유**: 상위 제어기와의 통신은 로봇의 임무 수행에 필수적이며, 통신 두절은 시스템 전체의 중단을 의미하기 때문입니다.

**독립 테스트**: 통신 채널을 의도적으로 끊거나 지연시켜, 로봇이 재연결 정책에 따라 정상적으로 반응하고, 최종적으로 명령 릴레이 기능을 활성화하는지 검증할 수 있습니다.

**인수 시나리오**:

1.  **주어진 상황** 로봇이 상위 제어기와 정상 통신 중일 때, **언제** 통신 채널에 장애가 발생하면, **그러면** 로봇은 3회, 5초 간격으로 재연결을 시도해야 합니다.
2.  **주어진 상황** 재연결 시도가 모두 실패했을 때, **언제** 인접 로봇으로부터 P2P 통신을 통해 임무 명령을 수신하면, **그러면** 로봇은 해당 임무를 수행하고, 완료 후 릴레이 경로를 통해 결과를 보고해야 합니다.

---

### 사용자 스토리 2 - 다양한 주변 장치와의 표준화된 인터락 (우선순위: P2)

로봇은 리프트, 충전기, 컨베이어 등 다양한 주변 장치와 표준화된 인터페이스를 통해 안전한 인터락 절차를 수행해야 합니다.

**이 우선순위인 이유**: 주변 장치와의 안전하고 효율적인 상호작용을 보장하고, 새로운 장치 추가 시 확장성을 확보합니다.

**독립 테스트**: 각 주변 장치(시뮬레이션 또는 실제)와의 인터락 시나리오를 테스트하여, 로봇이 정확한 순서와 타임아웃 처리에 따라 동작하는지 검증할 수 있습니다.

**인수 시나리오**:

1.  **주어진 상황** 로봇이 충전소에 도착했을 때, **언제** `ChargingState`로 전환되면, **그러면** 로봇은 충전기와의 인터락 절차를 시작하고, 충전기의 `Ready` 상태를 확인한 후 충전을 시작해야 합니다.
2.  **주어진 상황** 주변 장치와의 통신 중 응답이 없을 때, **언제** 설정된 타임아웃이 만료되면, **그러면** 시스템은 `FAULT` 상태로 전환하고 관련 알람을 발생시켜야 합니다.

---

### 엣지 케이스

- 여러 RFID/QR 리더기에서 동시에 다른 데이터가 읽힐 경우, 어떤 데이터를 신뢰해야 합니까?
- 로봇의 속도가 매우 빠를 때, 위치 보정 태그 데이터의 신뢰성을 어떻게 보장합니까?

## 요구사항 *(필수)*

### 기능적 요구사항

- **FR-001**: `InterfaceModule`은 TCP/IP, EtherCAT, CANOpen, RFID 등 다양한 통신 프로토콜을 추상화하여 일관된 방식으로 처리해야 합니다.
- **FR-002**: 상위 제어기와의 통신 단절 시, 시스템은 설정된 정책(재시도 횟수, 간격)에 따라 자동 재연결을 시도해야 합니다.
- **FR-003**: 재연결 실패 시, 시스템은 인접 로봇을 통한 명령 릴레이 기능을 활성화해야 합니다.
- **FR-004**: 시스템은 복수의 RFID/QR 리더기에서 수집된 데이터를 융합하여 가장 신뢰도 높은 데이터를 최종 결과로 채택해야 합니다.
- **FR-005**: 로봇의 속도가 지정된 임계값을 초과할 경우, 위치 보정 태그 데이터의 가중치를 낮추거나 무시해야 합니다.
- **FR-006**: 모든 주변 장치는 표준화된 `PeripheralInterface`(Command/Status)를 통해 상호작용해야 합니다.
- **FR-007**: 주변 장치와의 인터락은 로봇의 `StateMachine`과 연동된 전용 상태(`ChargingState`, `LiftingState` 등) 내에서 관리되어야 합니다.
- **FR-008**: 명령 릴레이 활성화 시, 가장 강한 P2P 통신 신호를 가진 인접 로봇을 우선적으로 선택하여 통신 경로를 설정해야 합니다.

### 주요 엔티티

- **InterfaceModule**: 외부 시스템(WCS, 주변 장치)과의 모든 통신을 담당하는 모듈입니다.
- **PeripheralInterface**: 모든 주변 장치가 상속받는 표준 인터페이스입니다. (Command, Status 포함)
- **ConnectionHealthCheck**: 상위 제어기와의 연결 상태를 주기적으로 확인하는 기능입니다.
- **CommandRelay**: 통신 실패 시 인접 로봇을 통해 명령을 중계하는 기능입니다.

## 성공 기준 *(필수)*

### 측정 가능한 결과

- **SC-001**: 상위 제어기와의 통신 단절 시, 99%의 경우 10초 이내에 재연결에 성공하거나 명령 릴레이 모드로 전환되어야 합니다.
- **SC-002**: RFID/QR 데이터 인식 성공률은 99.5% 이상이어야 합니다.
- **SC-003**: 주변 장치와의 인터락 실패율은 0.1% 미만이어야 합니다.
- **SC-004**: 새로운 종류의 주변 장치를 시스템에 통합하는 데 걸리는 시간은 8시간을 넘지 않아야 합니다. (인터페이스 준수 시)
